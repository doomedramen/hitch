# Releasing Hitch

This document explains how to create releases of Hitch with automated binary builds and distribution.

## Overview

Hitch uses [GoReleaser](https://goreleaser.com/) to automate the release process. When you push a version tag (e.g., `v1.0.0`), GitHub Actions automatically:

1. Builds binaries for multiple platforms (macOS, Linux, Windows)
2. Creates a GitHub Release with changelogs
3. Uploads binaries and checksums
4. Updates the Homebrew tap (once configured)

## Prerequisites

### 1. Install GoReleaser (for local testing)

```bash
# macOS
brew install goreleaser/tap/goreleaser

# Linux
go install github.com/goreleaser/goreleaser@latest

# Verify
goreleaser --version
```

### 2. Create Homebrew Tap Repository

Before your first release, create the Homebrew tap:

```bash
# On GitHub, create a new repository named: homebrew-hitch
# (Homebrew naming convention: homebrew-<formula-name>)

# Initialize it with a README
# GoReleaser will create the Formula/ directory automatically
```

**Repository:** `https://github.com/DoomedRamen/homebrew-hitch`

**Structure (GoReleaser creates this):**
```
homebrew-hitch/
├── README.md
└── Formula/
    └── hitch.rb  # Auto-generated by GoReleaser
```

### 3. Configure GitHub Token (for Homebrew updates)

**Optional but recommended** - Allows GoReleaser to update your Homebrew tap automatically:

1. Go to GitHub Settings → Developer Settings → Personal Access Tokens → Tokens (classic)
2. Generate new token with `repo` scope
3. Add as repository secret: `HOMEBREW_TAP_TOKEN`
4. Uncomment the line in `.github/workflows/release.yml`:
   ```yaml
   HOMEBREW_TAP_GITHUB_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
   ```

## Release Process

### Local Testing (Snapshot Build)

Before creating a real release, test locally:

```bash
# Clean build directory
rm -rf dist/

# Create a snapshot build (no tag required)
goreleaser release --snapshot --clean

# Check the binaries
ls -lh dist/

# Test a binary
./dist/hitch_darwin_arm64_v8.0/hitch --version
./dist/hitch_linux_amd64_v1/hitch --version
```

**What this does:**
- Builds for all configured platforms
- Creates archives in `dist/`
- Does NOT create a GitHub Release (snapshot mode)
- Does NOT push anything
- Generates a changelog from commits

### Creating a Release

#### Step 1: Prepare the Release

```bash
# Make sure you're on main branch
git checkout main
git pull origin main

# Ensure all changes are committed
git status

# Run tests
go test ./...

# Optional: Test build locally
goreleaser release --snapshot --clean
```

#### Step 2: Create and Push Tag

```bash
# Create a version tag
# Use semantic versioning: v<major>.<minor>.<patch>
git tag -a v0.1.0 -m "Initial release

Features:
- Environment management (promote, demote, rebuild)
- Lock/unlock commands
- Cleanup stale branches
- Git hook integration
- Hitched branch architecture

Installation via Homebrew, curl, or go install"

# Push the tag
git push origin v0.1.0
```

#### Step 3: Monitor GitHub Actions

1. Go to: https://github.com/DoomedRamen/hitch/actions
2. Watch the "Release" workflow run
3. Wait for completion (~5-10 minutes)

**What happens:**
- ✅ Checks out code
- ✅ Sets up Go
- ✅ Runs tests
- ✅ Builds binaries for all platforms
- ✅ Creates GitHub Release
- ✅ Uploads binaries and checksums
- ✅ Updates Homebrew tap (if token configured)

#### Step 4: Verify Release

Check the release page:
```
https://github.com/DoomedRamen/hitch/releases/latest
```

**You should see:**
- Release notes with changelog
- Binaries for each platform:
  - `hitch_0.1.0_darwin_amd64.tar.gz` (macOS Intel)
  - `hitch_0.1.0_darwin_arm64.tar.gz` (macOS Apple Silicon)
  - `hitch_0.1.0_linux_amd64.tar.gz` (Linux)
  - `hitch_0.1.0_linux_arm64.tar.gz` (Linux ARM)
  - `hitch_0.1.0_windows_amd64.zip` (Windows)
- `checksums.txt` for verification

#### Step 5: Test Installation Methods

**Homebrew (once tap is set up):**
```bash
brew tap DoomedRamen/hitch
brew install hitch
hitch --version
```

**curl installer:**
```bash
curl -fsSL https://raw.githubusercontent.com/DoomedRamen/hitch/main/install.sh | bash
hitch --version
```

**go install:**
```bash
go install github.com/DoomedRamen/hitch/cmd/hitch@v0.1.0
hitch --version
```

**Manual download:**
```bash
# Visit releases page and download appropriate binary
open https://github.com/DoomedRamen/hitch/releases/latest
```

## Version Numbering

Follow [Semantic Versioning](https://semver.org/):

- **v0.x.x** - Initial development, API may change
- **v1.0.0** - First stable release
- **v1.x.0** - New features (backwards compatible)
- **v1.x.x** - Bug fixes

**Examples:**
- `v0.1.0` - Initial alpha release
- `v0.2.0` - Added new commands
- `v0.2.1` - Bug fix
- `v1.0.0` - Stable release

## Troubleshooting

### Release Failed in GitHub Actions

Check the Actions logs:
```
https://github.com/DoomedRamen/hitch/actions
```

**Common issues:**
- Tests failed → Fix tests before releasing
- Build failed → Check Go version compatibility
- Permission denied → Check GitHub token permissions

### GoReleaser Local Build Failed

```bash
# Check configuration
goreleaser check

# Clean and retry
rm -rf dist/
goreleaser release --snapshot --clean
```

### Homebrew Tap Not Updated

**If using HOMEBREW_TAP_TOKEN:**
1. Verify token has `repo` scope
2. Check it's added as `HOMEBREW_TAP_TOKEN` secret
3. Uncomment the env var in `.github/workflows/release.yml`

**Manual update:**
```bash
# Clone your tap
git clone https://github.com/DoomedRamen/homebrew-hitch.git
cd homebrew-hitch

# Update Formula/hitch.rb manually
# Change version and SHA256 checksums

git add Formula/hitch.rb
git commit -m "Update hitch to v0.1.0"
git push origin main
```

### Install Script Doesn't Work

**Test locally:**
```bash
# Run with debug output
bash -x install.sh
```

**Common issues:**
- Architecture detection wrong → Update `detect_os_arch()` function
- Download URL 404 → Verify release artifacts exist
- Permission denied → Run with sudo or install to ~/bin

## Release Checklist

Use this checklist for each release:

- [ ] All changes committed and pushed
- [ ] Tests passing (`go test ./...`)
- [ ] Version number decided
- [ ] Changelog/release notes prepared
- [ ] Local snapshot build tested (`goreleaser release --snapshot --clean`)
- [ ] Git tag created with proper message
- [ ] Tag pushed to GitHub
- [ ] GitHub Actions completed successfully
- [ ] Release appears on GitHub with all binaries
- [ ] Homebrew formula updated (check tap repo)
- [ ] Installation methods tested:
  - [ ] Homebrew
  - [ ] curl installer
  - [ ] go install
  - [ ] Manual download
- [ ] README updated (if needed)
- [ ] Announced to team

## Automated Release Notes

GoReleaser automatically generates release notes from commit messages. Use conventional commits for better changelogs:

```bash
# Features
git commit -m "feat: add hitch merge command"

# Bug fixes
git commit -m "fix: resolve race condition in lock acquisition"

# Documentation
git commit -m "docs: update installation instructions"

# Internal changes (excluded from changelog)
git commit -m "chore: update dependencies"
```

These will be grouped in the release notes:
- **Features** - `feat:` commits
- **Bug Fixes** - `fix:` commits
- **Others** - Everything else (except `docs:`, `test:`, `chore:`)

## CI/CD Pipeline

```
Developer                GitHub Actions              Users
    │                          │                       │
    │ git tag v1.0.0          │                       │
    │─────────────────────────>│                       │
    │                          │                       │
    │                          │ 1. Run tests          │
    │                          │ 2. Build binaries     │
    │                          │ 3. Create release     │
    │                          │ 4. Upload artifacts   │
    │                          │ 5. Update Homebrew    │
    │                          │                       │
    │                          │                       │
    │                          │  brew install hitch   │
    │                          │<──────────────────────│
    │                          │                       │
    │                          │  curl install.sh      │
    │                          │<──────────────────────│
    │                          │                       │
```

## Next Steps

After your first release:

1. **Monitor usage** - Watch GitHub Stars/Forks
2. **Gather feedback** - Create GitHub Discussions
3. **Plan next release** - Use GitHub Issues/Projects
4. **Consider** - Package managers (apt, yum, pacman, scoop, etc.)

## References

- [GoReleaser Documentation](https://goreleaser.com/)
- [GitHub Actions Documentation](https://docs.github.com/en/actions)
- [Homebrew Formula Cookbook](https://docs.brew.sh/Formula-Cookbook)
- [Semantic Versioning](https://semver.org/)
